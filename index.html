<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Un Encuentro con Dios - Inscripción</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-image: url('imagen-retiro.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .content-overlay {
            background: rgba(255, 255, 255, 0.95);
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Header con Logo -->
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white">
                <div class="flex items-center justify-center gap-4 mb-3">
                    <img src="logo-iglesia.png" alt="Logo Iglesia" class="h-16 w-16 object-contain bg-white rounded-full p-1">
                    <h1 class="text-3xl font-bold text-center">Un Encuentro con Dios</h1>
                </div>
                <p class="text-center text-purple-100 text-lg">Retiro Espiritual</p>
                <p class="text-center text-purple-200 mt-2">📅 Domingo 2 de Noviembre, 2025 - 9:30 hs</p>
                <p class="text-center text-purple-200">📍 Terminal de Ómnibus de María Grande</p>
            </div>

            <!-- Navegación -->
            <div class="flex border-b" id="nav-tabs">
                <button onclick="mostrarVista('formulario')" id="tab-formulario" class="flex-1 py-4 px-6 font-semibold transition-colors bg-purple-50 text-purple-700 border-b-2 border-purple-600">
                    Formulario
                </button>
                <button onclick="mostrarVista('admin')" id="tab-admin" class="flex-1 py-4 px-6 font-semibold transition-colors text-gray-600 hover:bg-gray-50">
                    Administrador
                </button>
            </div>

            <!-- Contenido -->
            <div class="p-6 content-overlay">
                <!-- Vista Formulario -->
                <div id="vista-formulario">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Inscripción al Retiro</h2>
                        <p class="text-gray-600 mb-6">Completa tus datos para confirmar tu participación en "Un Encuentro con Dios"</p>
                        
                        <div id="mensaje-form" class="mb-6 p-4 rounded-lg hidden"></div>

                        <div class="space-y-5">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre *</label>
                                    <input type="text" id="nombre" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="Tu nombre">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Apellido *</label>
                                    <input type="text" id="apellido" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="Tu apellido">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Edad *</label>
                                    <input type="number" id="edad" min="1" max="120" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="Tu edad">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ciudad *</label>
                                    <select id="ciudad" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition bg-white">
                                        <option value="">Selecciona tu ciudad</option>
                                        <option value="María Grande">María Grande</option>
                                        <option value="El Pingo">El Pingo</option>
                                        <option value="Est. Sosa">Est. Sosa</option>
                                        <option value="Tabossi">Tabossi</option>
                                        <option value="Otras">Otras</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Teléfono de Contacto *</label>
                                <input type="tel" id="telefono" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="+54 9 343 123-4567">
                            </div>

                            <button onclick="inscribir()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-lg font-bold text-lg hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl">
                                Confirmar Inscripción
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Vista Admin Login -->
                <div id="vista-admin" class="hidden">
                    <div class="max-w-md mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Acceso Administrador</h2>
                        
                        <div id="mensaje-admin" class="mb-6 p-4 rounded-lg text-center hidden"></div>

                        <div class="bg-purple-50 p-6 rounded-xl">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Ingresa la clave de administrador:</label>
                            <input type="password" id="clave-admin" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition mb-4" placeholder="Clave de acceso" onkeypress="if(event.key==='Enter') verificarClave()">
                            <button onclick="verificarClave()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-lg font-bold hover:from-purple-700 hover:to-indigo-700 transition-all">
                                Ingresar
                            </button>
                        </div>

                        <div class="mt-6 p-4 bg-blue-50 rounded-lg text-sm text-blue-700">
                            <p class="font-semibold mb-1">ℹ️ Información</p>
                            <p>Solo los administradores pueden ver el listado de inscriptos y el código QR.</p>
                        </div>

                        <div class="mt-4 p-4 bg-green-50 rounded-lg text-sm text-green-700">
                            <p class="font-semibold mb-1">🔔 Notificaciones</p>
                            <p class="mb-2">Una vez que inicies sesión, podrás activar las notificaciones push para recibir alertas cuando alguien se inscriba.</p>
                        </div>
                    </div>
                </div>

                <!-- Vista Inscriptos (Admin) -->
                <div id="vista-inscriptos" class="hidden">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                        <h2 class="text-2xl font-bold text-gray-800">Lista de Inscriptos (<span id="contador-inscriptos">0</span>)</h2>
                        <div class="flex gap-3 flex-wrap">
                            <button onclick="activarNotificaciones()" id="btn-notificaciones" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                                🔔 Activar Notificaciones
                            </button>
                            <button onclick="exportarCSV()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                                Exportar CSV
                            </button>
                            <button onclick="cerrarSesion()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition text-sm">
                                Cerrar Sesión
                            </button>
                        </div>
                    </div>

                    <div id="estado-notificaciones" class="mb-4 p-3 rounded-lg hidden text-sm"></div>

                    <div id="tabla-inscriptos"></div>
                </div>

                <!-- Vista QR (Admin) -->
                <div id="vista-qr" class="hidden">
                    <div class="max-w-md mx-auto text-center">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Código QR de Inscripción</h2>
                            <button onclick="cerrarSesion()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition text-sm">
                                Cerrar Sesión
                            </button>
                        </div>
                        <p class="text-gray-600 mb-6">Comparte este código QR para que las personas puedan inscribirse fácilmente al retiro "Un Encuentro con Dios"</p>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg inline-block mb-6">
                            <img id="img-qr" src="" alt="Código QR de inscripción" class="w-64 h-64">
                        </div>

                        <a id="descargar-qr" download="qr-inscripcion-retiro.png" class="inline-flex items-center gap-2 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-semibold cursor-pointer">
                            Descargar Código QR
                        </a>

                        <div class="mt-8 p-4 bg-blue-50 rounded-lg text-left">
                            <p class="text-sm text-blue-800 font-semibold mb-2">💡 Instrucciones:</p>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>• Descarga el código QR</li>
                                <li>• Imprímelo o compártelo digitalmente</li>
                                <li>• Las personas pueden escanearlo con su celular</li>
                                <li>• Serán dirigidos directamente al formulario</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAlwzfCECuWObnXqvBT-6ED8UykFnNZXlE",
            authDomain: "retiro-inscripcion.firebaseapp.com",
            projectId: "retiro-inscripcion",
            storageBucket: "retiro-inscripcion.firebasestorage.app",
            messagingSenderId: "1052656436137",
            appId: "1:1052656436137:web:53a80f46715a5e3e027ab8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const messaging = getMessaging(app);

        const CLAVE_ADMIN = 'retiro2025';
        const FECHA_RETIRO = new Date('2025-11-02');
        let esAdmin = false;
        let unsubscribe = null;

        window.mostrarMensaje = function(id, texto, tipo) {
            const elemento = document.getElementById(id);
            elemento.innerHTML = texto;
            elemento.className = `mb-6 p-4 rounded-lg ${tipo === 'error' ? 'bg-red-50 border border-red-200 text-red-800' : tipo === 'warning' ? 'bg-blue-50 border border-blue-200 text-blue-800' : 'bg-green-50 border border-green-200 text-green-800'}`;
            elemento.classList.remove('hidden');
            setTimeout(() => elemento.classList.add('hidden'), 8000);
        };

        window.inscribir = async function() {
            const nombre = document.getElementById('nombre').value.trim();
            const apellido = document.getElementById('apellido').value.trim();
            const edad = document.getElementById('edad').value.trim();
            const ciudad = document.getElementById('ciudad').value;
            const telefono = document.getElementById('telefono').value.trim();

            if (!nombre || !apellido || !edad || !ciudad || !telefono) {
                mostrarMensaje('mensaje-form', 'Por favor completa todos los campos', 'error');
                return;
            }

            const hoy = new Date();
            if (hoy > FECHA_RETIRO) {
                mostrarMensaje('mensaje-form', 'La fecha del retiro ya ha pasado. No se pueden realizar más inscripciones.', 'error');
                return;
            }

            try {
                // Verificar si ya está inscri
